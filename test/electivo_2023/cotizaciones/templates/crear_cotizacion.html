{% extends "base1.html" %}

{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  .stock-input {
    width: 60px !important; 
  }
</style>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
<form method="post" id="formFactura">
  {% csrf_token %}
  <div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
      <h2 colspan="2">Crear Cotización</h2>
      <button class="btn btn-info" type="submit">Crear Cotización</button>
      <a href="{% url 'listado_cotizacion' %}" class="btn btn-primary">Listado</a>
      <a href="{% url 'generar_reporte' %}" class="btn btn-primary">Reporte</a>
      <a href="{% url 'cotizaciones_main' %}" class="btn btn-danger">Volver</a>
    </div>
    <div class="card-body">
      <label for="cliente">Cliente:</label>
      <select name="cliente" id="cliente" class="form-control">
        {% for cliente in clientes %}
          <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="table-responsive">
      <table id="productos-table" class="table table-bordered">
        <thead>
          <tr>
            <th>Nombre del producto</th>
            <th>Stock</th>
            <th>Cantidad</th>
            <th>Precio</th>
            <th>Descuento (%)</th> 
            <th>Total</th>
            <th>Opciones</th>
          </tr>
        </thead>
        <tbody>
          <tr class="producto-row">
            <td>
              <select name="producto" class="form-control producto-select" required>
                <option value="">Seleccione un producto</option>
                {% for producto in productos %}
                  <option value="{{ producto.id }}"data-precio="{{ producto.precio }}" data-stock="{{ producto.cantidad }}">{{ producto.nombre }}</option>
                {% endfor %}
              </select>
            </td>
            <td><input type="text" name="stock" class="form-control stock-input" required readonly></td>
            <td><input type="number" name="cantidad" class="form-control cantidad-input" required ></td>
            <td><input type="number" name="precio" class="form-control precio-input" required readonly></td>
            <td><input type="number" name="descuento" class="form-control descuento-input" required value="0"></td>  
            <td><input type="number" name="total" class="form-control total-input" readonly></td>
            <td><button type="button" class="btn btn-danger remove-producto">Eliminar</button></td>
          </tr>
        </tbody>
      </table>
    </div>
    <div id="total-final" class="d-flex justify-content-end mb-3">
      <h4>Total Final: <span id="total-final-value">0</span></h4>
    </div>
    <div style="display: flex; justify-content: center; margin-bottom: 20px;">
    <button type="button" class="btn btn-primary add-producto">Añadir Producto</button>
  </div>
  </div>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function() {
    $('.add-producto').click(function() {
      var productoRow = $('.producto-row').first().clone();
      productoRow.find('select').val('');
      productoRow.find('input[name="cantidad"]').val('');
      productoRow.find('input[name="descuento"]').val('0');
      productoRow.find('.remove-producto').show();
      $('#productos-table tbody').append(productoRow);
    });

    $(document).on('click', '.remove-producto', function() {
      $(this).closest('tr').remove();
      calcularTotalFinal();
    });

    $(document).on('change', '.producto-select', function() {
      var selectedOption = $(this).find(':selected');
      var precio = selectedOption.data('precio');
      var stock = selectedOption.data('stock');
      var cantidadInput = $(this).closest('.producto-row').find('.cantidad-input');
      var stockInput = $(this).closest('.producto-row').find('.stock-input');
      var descuentoInput = $(this).closest('.producto-row').find('.descuento-input');
      var totalInput = $(this).closest('.producto-row').find('.total-input');
      
      $(this).closest('.producto-row').find('.precio-input').val(precio);
      stockInput.val(stock);
      
      cantidadInput.attr('max', stock);
      
      if (parseInt(cantidadInput.val()) > stock) {
        cantidadInput.val('');
      }

      calcularTotal(cantidadInput, precio, descuentoInput, totalInput);
      calcularTotalFinal();
    });

    
    $(document).on('input', '.cantidad-input', function() {
      var cantidadInput = $(this);
      var stock = cantidadInput.closest('.producto-row').find('.stock-input').val();
      var precio = cantidadInput.closest('.producto-row').find('.precio-input').val();
      var descuentoInput = cantidadInput.closest('.producto-row').find('.descuento-input');
      var totalInput = cantidadInput.closest('.producto-row').find('.total-input');
      if (parseInt(cantidadInput.val()) > stock) {
        cantidadInput.val('');
      }
      calcularTotal(cantidadInput, precio, descuentoInput, totalInput);
      calcularTotalFinal();
    });
    $(document).on('input', '.descuento-input', function() {
      var descuentoInput = $(this);
      var cantidadInput = descuentoInput.closest('.producto-row').find('.cantidad-input');
      var precio = descuentoInput.closest('.producto-row').find('.precio-input').val();
      var totalInput = descuentoInput.closest('.producto-row').find('.total-input');
      calcularTotal(cantidadInput, precio, descuentoInput, totalInput);
      calcularTotalFinal();
    });
    function calcularTotal(cantidadInput, precio, descuentoInput, totalInput) {
      var cantidad = parseInt(cantidadInput.val()) || 0;
      var descuento = parseInt(descuentoInput.val()) || 0;
      var total = cantidad * precio - (cantidad * precio * descuento / 100);
      totalInput.val(Math.round(total));
    }
    function calcularTotalFinal() {
      var totalFinal = 0;
      $('.total-input').each(function() {
        var total = parseFloat($(this).val()) || 0;
        totalFinal += total;
      });
      $('#total-final-value').text(Math.round(totalFinal));
    }
    
    $(document).on('input', '.descuento-input', function() {
      var descuentoInput = $(this);
      var cantidadInput = descuentoInput.closest('.producto-row').find('.cantidad-input');
      var precio = descuentoInput.closest('.producto-row').find('.precio-input').val();
      var totalInput = descuentoInput.closest('.producto-row').find('.total-input');
      var descuento = parseInt(descuentoInput.val()) || 0;
      if (descuento < 0) {
        descuentoInput.val(0);
      } else if (descuento > 100) {
        descuentoInput.val(100);
      }
    calcularTotal(cantidadInput, precio, descuentoInput, totalInput);
  });

  });
</script>
<style>
  #total-final {
    background-color: #f8f9fa;
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 5px;
  }
  #total-final h4 {
    margin: 0;
  }
  #total-final span {
    font-weight: bold;
    margin-left: 5px;
  }
</style>

{% endblock %}
